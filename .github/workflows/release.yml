name: ğŸ“¦ Nuget package publish

on:
  workflow_dispatch:
    inputs:
      dry_run:
        description: 'Perform a dry run (pack only, no push or release)'
        required: false
        default: true
        type: boolean

env:
   NUGET_TOKEN: ${{ secrets.NUGET_TOKEN }}

jobs:

  nuget:
    name: ğŸ“¦ Nuget - Publish package
    runs-on: ubuntu-latest
    timeout-minutes: 15
    permissions:
      contents: write
      packages: write
    steps:
      # ğŸ›’ Checkout the repository
      - name: ğŸ›’ Checkout
        uses: actions/checkout@v4

      # ğŸŸ£ Setup .NET
      - name: ğŸŸ£ Setup .NET 9.0
        uses: actions/setup-dotnet@v3
        with:
          dotnet-version: 9.0.x

      # ğŸ” Extract Version from Directory.Build.props
      - name: ğŸ” Extract Version
        id: extract_version
        run: |
          # Extract AssemblyVersion
          assemblyVersion=$(grep -oP '(?<=<AssemblyVersion>).*?(?=</AssemblyVersion>)' Directory.Build.props)

          # Extract Version
          version=$(grep -oP '(?<=<Version>).*?(?=</Version>)' Directory.Build.props)

          # Replace $(AssemblyVersion) in version with the value of assemblyVersion
          version=$(echo "$version" | sed "s/\$(AssemblyVersion)/$assemblyVersion/g")

          # Ensure version is valid
          if [[ ! "$version" =~ ^[0-9]+\.[0-9]+\.[0-9]+(-[a-zA-Z0-9]+(\.[0-9]+)?)?$ ]]; then
            echo "::error::Invalid version format in Directory.Build.props: $VERSION"
            exit 1
          fi

          echo "Version=$version" >> $GITHUB_ENV
          echo "Extracted and Resolved AssemblyVersion: $assemblyVersion"
          echo "Extracted and Resolved Version: $version"

      # ğŸ“ Parse changelog for the version
      - name: ğŸ“ Parse changelog
        id: parse_changelog
        run: |
          version=${{ env.Version }}
          changelog=$(awk "/^# $version /,/^# /{if (!/^# $version /) print}" CHANGELOG.md | sed '$d')
          echo "Changelog=$changelog" >> $GITHUB_ENV
          echo "Parsed changelog for version $version"
          echo "$changelog"

      # ğŸ“¦ Pack the project
      - name: ğŸ“¦ Pack
        run: |
          dotnet pack Updatum --configuration Release --output .

      # ğŸ›‘ Conditional: Skip push and release if dry run
      - name: ğŸ›‘ Check dry run
        if: ${{ github.event.inputs.dry_run == 'true' }}
        run: echo "Dry run enabled. Skipping push and release." && exit 0

      # ğŸ·ï¸ Create a Git tag
      - name: ğŸ·ï¸ Create Git tag
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git tag -a "v${{ env.Version }}" -m "Release v${{ env.Version }}"
          git push origin "v${{ env.Version }}"

      # ğŸš€ Push to nuget.org
      - name: ğŸš€ Push nuget.org
        run: dotnet nuget push *.nupkg --source https://api.nuget.org/v3/index.json --api-key ${NUGET_TOKEN} --skip-duplicate

      # ğŸš€ Push to GitHub Packages
      - name: ğŸš€ Push Github
        run: dotnet nuget push *.nupkg --source https://nuget.pkg.github.com/${{ github.repository_owner }}/index.json --api-key ${{ github.token }} --skip-duplicate

      # ğŸ“ Create GitHub release
      - name: ğŸ“ Create GitHub release
        uses: actions/create-release@v1
        with:
          tag_name: "v${{ env.Version }}"
          release_name: "v${{ env.Version }}"
          body: ${{ env.Changelog }}
          draft: false
          prerelease: ${{ contains(env.Version, '-alpha') || contains(env.Version, '-beta') || contains(env.Version, '-preview') || contains(env.Version, '-rc')  }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}